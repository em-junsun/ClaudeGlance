name: Build ClaudeGlance

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.2.1-fix)'
        required: true
        default: '1.2.1-fix'
  push:
    branches: [ main ]
    paths:
      - 'ClaudeGlance/Views/HUDWindowController.swift'
      - '.github/workflows/build.yml'

jobs:
  build:
    name: Build macOS App
    runs-on: macos-latest

    steps:
      - name: æ£€æŸ¥ä»£ç 
        uses: actions/checkout@v4

      - name: æ˜¾ç¤º Xcode ç‰ˆæœ¬
        run: |
          xcodebuild -version
          swift --version

      - name: åˆ—å‡ºé¡¹ç›®é…ç½®
        run: |
          echo "=== é¡¹ç›®ç›®å½•ç»“æž„ ==="
          ls -la
          echo ""
          echo "=== Xcode é¡¹ç›®æ–‡ä»¶ ==="
          ls -la *.xcodeproj/
          echo ""
          echo "=== å¯ç”¨çš„ schemes ==="
          xcodebuild -project ClaudeGlance.xcodeproj -list

      - name: ç¼–è¯‘åº”ç”¨
        run: |
          xcodebuild \
            -project ClaudeGlance.xcodeproj \
            -scheme ClaudeGlance \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: æŸ¥æ‰¾æž„å»ºäº§ç‰©
        run: |
          echo "=== æŸ¥æ‰¾ .app æ–‡ä»¶ ==="
          find build -name "*.app" -type d
          echo ""
          echo "=== æŸ¥æ‰¾æ‰€æœ‰æž„å»ºäº§ç‰© ==="
          ls -laR build/Build/Products/

      - name: åˆ›å»º DMG é•œåƒ
        run: |
          APP_PATH=$(find build -name "ClaudeGlance.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° ClaudeGlance.app"
            echo "=== è°ƒè¯•ä¿¡æ¯ ==="
            find build -type f -name "*.app" 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°ä»»ä½• .app æ–‡ä»¶"
            ls -la build/ || echo "build ç›®å½•ä¸ºç©º"
            exit 1
          fi

          echo "âœ… æ‰¾åˆ°åº”ç”¨: $APP_PATH"
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV

          # éªŒè¯åº”ç”¨ç»“æž„
          echo "=== åº”ç”¨ç»“æž„ ==="
          ls -la "$APP_PATH"
          ls -la "$APP_PATH/Contents/"

      - name: ä¸Šä¼ åº”ç”¨
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ClaudeGlance-${{ github.event.inputs.version }}.app
          path: ${{ env.APP_PATH }}
          retention-days: 30

      - name: æž„å»ºæ‘˜è¦
        if: success()
        run: |
          echo "## âœ… æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ä¸‹è½½äº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "è¯·ä»Žä¸‹æ–¹çš„ Artifacts ä¸­ä¸‹è½½ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- \`ClaudeGlance-${{ github.event.inputs.version }}.app\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®‰è£…æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½å¹¶è§£åŽ‹ ClaudeGlance.app" >> $GITHUB_STEP_SUMMARY
          echo "2. æ‹–æ‹½åˆ° /Applications æ–‡ä»¶å¤¹" >> $GITHUB_STEP_SUMMARY
          echo "3. è¿è¡Œ: open /Applications/ClaudeGlance.app" >> $GITHUB_STEP_SUMMARY
