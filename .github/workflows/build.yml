name: Build ClaudeGlance

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.2.1-fix)'
        required: true
        default: '1.2.1-fix'
  push:
    branches: [ main ]
    paths:
      - 'ClaudeGlance/Views/HUDWindowController.swift'
      - '.github/workflows/build.yml'

jobs:
  build:
    name: Build macOS App
    runs-on: macos-latest

    steps:
      - name: æ£€æŸ¥ä»£ç 
        uses: actions/checkout@v4

      - name: æ˜¾ç¤º Xcode ç‰ˆæœ¬
        run: |
          xcodebuild -version
          swift --version

      - name: ç¼–è¯‘åº”ç”¨
        run: |
          xcodebuild \
            -project ClaudeGlance.xcodeproj \
            -scheme ClaudeGlance \
            -configuration Release \
            -derivedDataPath build \
            CLEAN_BUILD=1 \
            build

      - name: æŸ¥æ‰¾æž„å»ºäº§ç‰©
        run: |
          find build -name "*.app" -type d
          ls -la build/Build/Products/Release/

      - name: åˆ›å»º DMG é•œåƒ
        run: |
          APP_PATH=$(find build/Build/Products/Release -name "ClaudeGlance.app" -type d | head -1)
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p dmg_temp
          
          # å¤åˆ¶åº”ç”¨
          cp -R "$APP_PATH" dmg_temp/
          
          # åˆ›å»º DMG
          hdiutil create -volname "ClaudeGlance" \
            -srcfolder dmg_temp \
            -ov \
            -format UDZO \
            "ClaudeGlance-${{ github.event.inputs.version }}.dmg"

      - name: ä¸Šä¼ åº”ç”¨
        uses: actions/upload-artifact@v4
        with:
          name: ClaudeGlance-${{ github.event.inputs.version }}.app
          path: ${{ env.APP_PATH }}
          retention-days: 30

      - name: ä¸Šä¼  DMG
        uses: actions/upload-artifact@v4
        with:
          name: ClaudeGlance-${{ github.event.inputs.version }}.dmg
          path: ClaudeGlance-${{ github.event.inputs.version }}.dmg
          retention-days: 30

      - name: æž„å»ºæ‘˜è¦
        run: |
          echo "## âœ… æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ä¸‹è½½äº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "è¯·ä»Žä¸‹æ–¹çš„ Artifacts ä¸­ä¸‹è½½ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- \`ClaudeGlance-${{ github.event.inputs.version }}.app\` - ç›´æŽ¥æ‹–å…¥ Applications" >> $GITHUB_STEP_SUMMARY
          echo "- \`ClaudeGlance-${{ github.event.inputs.version }}.dmg\` - æŒ‚è½½åŽå®‰è£…" >> $GITHUB_STEP_SUMMARY
