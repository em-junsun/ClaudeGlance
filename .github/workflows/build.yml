name: Build ClaudeGlance

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.2.1-fix)'
        required: true
        default: '1.2.1-fix'
  push:
    branches: [ main ]
    paths:
      - 'ClaudeGlance/Views/HUDWindowController.swift'
      - '.github/workflows/build.yml'

jobs:
  build:
    name: Build macOS App
    runs-on: macos-latest

    steps:
      - name: æ£€æŸ¥ä»£ç 
        uses: actions/checkout@v4

      - name: æ˜¾ç¤º Xcode ç‰ˆæœ¬
        run: |
          xcodebuild -version
          swift --version

      - name: åˆ—å¯ç”¨çš„ schemes
        run: |
          xcodebuild -workspace ClaudeGlance.xcworkspace -list

      - name: ç¼–è¯‘åº”ç”¨
        run: |
          xcodebuild \
            -workspace ClaudeGlance.xcworkspace \
            -scheme ClaudeGlance \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: æŸ¥æ‰¾æž„å»ºäº§ç‰©
        run: |
          echo "æŸ¥æ‰¾ .app æ–‡ä»¶..."
          find build -name "*.app" -type d
          echo ""
          echo "Build/Build/Products ç›®å½•å†…å®¹:"
          ls -laR build/Build/Products/ || echo "ç›®å½•ä¸å­˜åœ¨"

      - name: åˆ›å»º DMG é•œåƒ
        run: |
          APP_PATH=$(find build -name "ClaudeGlance.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° ClaudeGlance.app"
            exit 1
          fi

          echo "âœ… æ‰¾åˆ°åº”ç”¨: $APP_PATH"
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV

          # éªŒè¯åº”ç”¨
          if [ -d "$APP_PATH" ]; then
            echo "âœ… åº”ç”¨ç›®å½•å­˜åœ¨"
            ls -la "$APP_PATH"
          else
            echo "âŒ åº”ç”¨ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p dmg_temp

          # å¤åˆ¶åº”ç”¨
          cp -R "$APP_PATH" dmg_temp/

          # åˆ›å»º DMG
          hdiutil create -volname "ClaudeGlance" \
            -srcfolder dmg_temp \
            -ov \
            -format UDZO \
            "ClaudeGlance-${{ github.event.inputs.version }}.dmg"

      - name: ä¸Šä¼ åº”ç”¨
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ClaudeGlance-${{ github.event.inputs.version }}.app
          path: ${{ env.APP_PATH }}
          retention-days: 30

      - name: ä¸Šä¼  DMG
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ClaudeGlance-${{ github.event.inputs.version }}.dmg
          path: ClaudeGlance-${{ github.event.inputs.version }}.dmg
          retention-days: 30

      - name: æž„å»ºæ‘˜è¦
        if: success()
        run: |
          echo "## âœ… æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ä¸‹è½½äº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "è¯·ä»Žä¸‹æ–¹çš„ Artifacts ä¸­ä¸‹è½½ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- \`ClaudeGlance-${{ github.event.inputs.version }}.app\` - ç›´æŽ¥æ‹–å…¥ Applications" >> $GITHUB_STEP_SUMMARY
          echo "- \`ClaudeGlance-${{ github.event.inputs.version }}.dmg\` - æŒ‚è½½åŽå®‰è£…" >> $GITHUB_STEP_SUMMARY
